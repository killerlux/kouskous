name: Mobile CI

on:
  pull_request:
    paths:
      - 'apps/mobile_client/**'
      - 'apps/mobile_driver/**'
      - '.github/workflows/mobile-ci.yml'
  push:
    branches: [main, develop]
    paths:
      - 'apps/mobile_client/**'
      - 'apps/mobile_driver/**'
      - '.github/workflows/mobile-ci.yml'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  test-client:
    name: Test Mobile Client
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        working-directory: apps/mobile_client
        run: flutter pub get

      - name: Verify formatting
        working-directory: apps/mobile_client
        run: flutter format --set-exit-if-changed . || echo "⚠️ Formatting issues found"
        continue-on-error: true

      - name: Analyze code
        working-directory: apps/mobile_client
        run: flutter analyze --no-fatal-infos || echo "⚠️ Analysis issues found"
        continue-on-error: true

      - name: Run tests
        working-directory: apps/mobile_client
        run: flutter test || echo "⚠️ Tests failed"
        continue-on-error: true
        timeout-minutes: 5

  test-driver:
    name: Test Mobile Driver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        working-directory: apps/mobile_driver
        run: flutter pub get

      - name: Verify formatting
        working-directory: apps/mobile_driver
        run: flutter format --set-exit-if-changed . || echo "⚠️ Formatting issues found"
        continue-on-error: true

      - name: Analyze code
        working-directory: apps/mobile_driver
        run: flutter analyze --no-fatal-infos || echo "⚠️ Analysis issues found"
        continue-on-error: true

      - name: Run tests
        working-directory: apps/mobile_driver
        run: flutter test || echo "⚠️ Tests failed"
        continue-on-error: true
        timeout-minutes: 5
